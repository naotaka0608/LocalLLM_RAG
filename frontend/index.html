<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM RAG System</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="app-layout">
        <!-- サイドバー -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="btn-new-chat" onclick="createNewChat()">+ 新規チャット</button>
            </div>
            <div class="chat-history" id="chatHistory">
                <!-- チャット履歴がここに表示される -->
            </div>
            <div class="sidebar-footer">
                <button class="btn-clear-history" onclick="clearAllHistory()">🗑️ 全ての履歴を削除</button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="container">
            <div class="header">
                <h1>Local LLM RAG System</h1>
                <p>Powered by Ollama, LangChain & FastAPI</p>
            </div>

            <div class="main-tabs">
                <button class="main-tab active" onclick="switchMainTab('chat')">💬 チャット</button>
                <button class="main-tab" onclick="switchMainTab('parameters')">🎛️ パラメータ</button>
                <button class="main-tab" onclick="switchMainTab('settings')">⚙️ 設定</button>
            </div>

        <div id="chat-main" class="main-tab-content active">
            <div class="card">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">チャット</h2>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap;" title="ドキュメントを参照して回答します">
                            <input type="checkbox" id="ragToggle" checked style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                            <span style="font-weight: 600; font-size: 0.9rem;">RAG使用</span>
                            <span style="font-size: 0.7rem; color: #666; display: none;" class="show-desktop">(ドキュメント参照)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap;" title="複数のクエリで検索して精度を上げます（処理が遅くなります）">
                            <input type="checkbox" id="queryExpansionToggle" style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                            <span style="font-weight: 600; font-size: 0.9rem;">クエリ拡張</span>
                            <span style="font-size: 0.7rem; color: #666; display: none;" class="show-desktop">(高精度・低速)</span>
                        </label>
                    </div>
                </div>
                <div class="chat-area">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="message-header">アシスタント</div>
                            <div>
                                <p style="font-size: 0.95rem;">こんにちは！ファイルをアップロードして、質問してください。</p>
                                <div style="margin-top: 8px; padding: 8px; background: #f0f8ff; border-left: 3px solid #667eea; border-radius: 5px; font-size: 0.85rem;">
                                    <strong>💡 より精度の高い回答を得るコツ:</strong>
                                    <ul style="margin: 5px 0 0 18px; padding: 0;">
                                        <li>具体的で明確な質問をする（例: 「○○の手順を教えてください」）</li>
                                        <li>コンテキストを含める（例: 「Pythonで○○する方法」）</li>
                                        <li>ドキュメント内の用語を使う（専門用語や正式名称）</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- タグフィルタエリア -->
                    <div id="tagFilterArea" style="display: none; margin-bottom: 12px; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span style="font-size: 0.85rem; color: #666; font-weight: 600;">🏷️ フィルタ:</span>
                            <div id="tagFilterButtons" style="display: flex; flex-wrap: wrap; gap: 6px; flex: 1;"></div>
                            <button onclick="clearTagFilter()" style="padding: 4px 10px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                ✕ クリア
                            </button>
                        </div>
                    </div>

                    <div class="input-area">
                        <input
                            type="text"
                            id="questionInput"
                            placeholder="質問を入力してください..."
                            onkeypress="handleKeyPress(event)"
                        >
                        <button class="btn btn-primary" id="sendButton" onclick="sendQuestion()">📤 送信</button>
                        <button class="btn btn-danger" id="stopButton" onclick="stopGeneration()" style="display: none; background: #ff5722; font-weight: bold;">⏹ 停止</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="parameters-main" class="main-tab-content">
            <div class="settings-grid">
                <div class="card">
                    <h2>⚡ 性能プリセット</h2>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">回答速度と精度のバランスを選択</p>
                    <select id="performancePreset" onchange="applyPerformancePreset()" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 0.95rem; margin-bottom: 10px;">
                        <option value="balanced">⚖️ バランス（推奨）</option>
                        <option value="speed">🚀 高速優先</option>
                        <option value="quality">🎯 高精度優先</option>
                        <option value="custom">🔧 カスタム</option>
                    </select>
                    <div id="presetDescription" style="font-size: 0.8rem; color: #666; padding: 8px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        速度と精度のバランスが取れた設定です
                    </div>

                    <!-- カスタムプリセット管理 -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <input type="text" id="customPresetName" placeholder="プリセット名を入力..."
                                   style="flex: 1; padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 0.9rem;">
                            <button onclick="saveCustomPreset()"
                                    style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; white-space: nowrap;">
                                💾 保存
                            </button>
                        </div>
                        <div id="customPresetsList" style="display: none; margin-top: 10px;">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px; font-weight: 600;">保存済みプリセット:</div>
                            <div id="customPresetsContainer"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>★ 主要パラメータ</h2>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">回答の品質と速度に最も影響するパラメータ</p>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            ★ Temperature (創造性): <span id="tempValue">0.3</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Temperature（創造性）</strong><br>
                                    範囲: 0.0 〜 1.0<br><br>
                                    <strong>低い (0.0〜0.3)</strong>: 一貫性が高く予測可能。事実ベースのQ&Aに最適<br><br>
                                    <strong>中程度 (0.4〜0.7)</strong>: バランス型<br><br>
                                    <strong>高い (0.8〜1.0)</strong>: 創造的で多様。ブレインストーミングに有効<br><br>
                                    推奨: RAG用途 0.2〜0.4
                                </div>
                            </div>
                        </label>
                        <input type="range" id="temperatureSlider" min="0" max="1" step="0.1" value="0.3"
                               oninput="updateTemperature(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">低い: 一貫性↑ 高い: 創造性↑</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            ★ 検索ドキュメント数: <span id="docsValue">10</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>検索ドキュメント数</strong>
                                    範囲: 3 〜 20<br>
                                    回答生成に使用するドキュメントの数
                                    <ul>
                                        <li><strong>少ない (3〜5)</strong>: 高速、シンプルなコンテキスト</li>
                                        <li><strong>多い (10〜20)</strong>: 正確で詳細な回答、多角的な視点</li>
                                    </ul>
                                    推奨: 標準 10、複雑な質問 15〜20
                                </div>
                            </div>
                        </label>
                        <input type="range" id="docsSlider" min="3" max="20" step="1" value="10"
                               oninput="updateDocs(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">少ない: 高速↑ 多い: 精度↑</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            ★ 検索範囲倍率: <span id="searchMultiplierValue">10倍</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>検索範囲倍率</strong>
                                    範囲: 2 〜 20倍<br>
                                    実際に検索する候補数 = ドキュメント数 × 倍率
                                    <ul>
                                        <li>例: ドキュメント数10、倍率10 → <strong>100件検索</strong>して上位10件を使用</li>
                                        <li><strong>低い倍率 (2〜5)</strong>: 高速</li>
                                        <li><strong>高い倍率 (10〜20)</strong>: より関連性の高い文書を選択、日本語検索精度向上</li>
                                    </ul>
                                    推奨: 標準 10、精度優先 15〜20
                                </div>
                            </div>
                        </label>
                        <input type="range" id="searchMultiplierSlider" min="2" max="20" step="1" value="10"
                               oninput="updateSearchMultiplier(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">検索時に取得する候補数（ドキュメント数×この倍率）。大きいほど精度↑</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="hybridSearchCheckbox" checked onchange="updateHybridSearch(this.checked)"
                                   style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                            <span>★ ハイブリッド検索 (BM25 + ベクトル)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>ハイブリッド検索</strong><br>
                                    BM25（キーワード検索）とベクトル検索を組み合わせた高精度検索
                                    <ul>
                                        <li><strong>ON</strong>: 日本語キーワード（例: EMC試験）の検索精度が大幅に向上。推奨設定</li>
                                        <li><strong>OFF</strong>: ベクトル検索のみ。セマンティック検索に特化</li>
                                    </ul>
                                    推奨: ONで使用
                                </div>
                            </div>
                        </label>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 5px;">日本語キーワード検索の精度向上。通常はON推奨</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            ★ Top-P (多様性): <span id="topPValue">0.9</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Top-P（多様性）</strong>
                                    範囲: 0.1 〜 1.0<br>
                                    Nucleus sampling。累積確率がこの値に達するまでのトークンから選択
                                    <ul>
                                        <li><strong>低い (0.1〜0.5)</strong>: 確実性の高い単語のみ、一貫性重視</li>
                                        <li><strong>高い (0.8〜1.0)</strong>: 多様な単語候補を考慮、表現の幅が広がる</li>
                                    </ul>
                                    推奨: 事実ベース 0.7〜0.8、標準 0.9
                                </div>
                            </div>
                        </label>
                        <input type="range" id="topPSlider" min="0.1" max="1.0" step="0.05" value="0.9"
                               oninput="updateTopP(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">低い: 確実性↑ 高い: 多様性↑</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            ★ Repeat Penalty (繰り返し抑制): <span id="repeatPenaltyValue">1.1</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Repeat Penalty（繰り返し抑制）</strong>
                                    範囲: 1.0 〜 1.5<br>
                                    同じ単語やフレーズの繰り返しを抑制
                                    <ul>
                                        <li><strong>1.0</strong>: ペナルティなし（繰り返しを許容）</li>
                                        <li><strong>1.1〜1.2</strong>: 適度に抑制（推奨）</li>
                                        <li><strong>1.3以上</strong>: 強い抑制（不自然になる可能性）</li>
                                    </ul>
                                    推奨: 標準 1.1
                                </div>
                            </div>
                        </label>
                        <input type="range" id="repeatPenaltySlider" min="1.0" max="1.5" step="0.05" value="1.1"
                               oninput="updateRepeatPenalty(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">低い: 繰り返しOK 高い: 抑制強</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            ★ Num Predict (最大生成トークン数): <span id="numPredictValue">-1 (無制限)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Num Predict（最大生成トークン数）</strong>
                                    範囲: -1（無制限）、128 〜 2048<br>
                                    生成する最大トークン数
                                    <ul>
                                        <li><strong>-1（無制限）</strong>: モデルが自然に終了するまで生成</li>
                                        <li><strong>128〜256</strong>: 短い回答（要約、簡潔な説明）</li>
                                        <li><strong>512〜1024</strong>: 標準的な回答</li>
                                        <li><strong>1024〜2048</strong>: 詳細な説明、長文生成</li>
                                    </ul>
                                    推奨: 詳細な回答なら -1
                                </div>
                            </div>
                        </label>
                        <input type="range" id="numPredictSlider" min="-1" max="2048" step="128" value="-1"
                               oninput="updateNumPredict(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">-1=無制限、128/256/512/1024など。短い回答が欲しい場合は小さく</div>
                    </div>
                </div>

                <div class="card">
                    <h2>詳細パラメータ</h2>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">高度な調整用パラメータ</p>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Top-K: <span id="topKValue">デフォルト (40)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Top-K</strong>
                                    範囲: 1 〜 100<br>
                                    各ステップで考慮する上位K個のトークン候補
                                    <ul>
                                        <li><strong>低い (10〜20)</strong>: より予測可能な出力</li>
                                        <li><strong>高い (60〜100)</strong>: より多様な出力</li>
                                    </ul>
                                    通常はTop-Pで制御するため、デフォルトのままでOK
                                </div>
                            </div>
                        </label>
                        <input type="range" id="topKSlider" min="1" max="100" step="1" value="40"
                               oninput="updateTopK(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">各ステップで考慮する上位K個のトークン</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Num Ctx (コンテキストサイズ): <span id="numCtxValue">デフォルト (2048)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Num Ctx（コンテキストサイズ）</strong>
                                    範囲: 512 〜 8192<br>
                                    モデルが一度に考慮できるトークン数（入力+出力）
                                    <ul>
                                        <li><strong>512〜1024</strong>: 短い会話に十分</li>
                                        <li><strong>2048</strong>: 標準的な会話と文書</li>
                                        <li><strong>4096〜8192</strong>: 長文の文書、長い会話履歴</li>
                                    </ul>
                                    注意: 大きくするほどメモリ使用量とレイテンシが増加
                                </div>
                            </div>
                        </label>
                        <input type="range" id="numCtxSlider" min="512" max="8192" step="512" value="2048"
                               oninput="updateNumCtx(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">モデルが一度に考慮できるトークン数。長文向けは大きく</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Seed (乱数シード): <span id="seedValue">ランダム</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Seed（乱数シード）</strong>
                                    範囲: 任意の整数、または空欄（ランダム）<br>
                                    同じシードで同じ結果を再現可能にする
                                    <ul>
                                        <li><strong>用途</strong>: デバッグ、A/Bテスト、結果の再現性確保</li>
                                    </ul>
                                    通常は空欄（ランダム）でOK
                                </div>
                            </div>
                        </label>
                        <input type="number" id="seedInput" placeholder="空欄=ランダム" min="0"
                               oninput="updateSeed(this.value)" style="width: 100%; padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0;">
                        <div style="font-size: 0.75rem; color: #999;">同じ値で結果を再現可能。デバッグ用</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Mirostat: <span id="mirostatValue">無効 (0)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Mirostat</strong>
                                    動的サンプリングアルゴリズム。perplexityを制御して一貫した品質を維持
                                    <ul>
                                        <li><strong>無効 (0)</strong>: 標準的なサンプリング（Temperature、Top-Pを使用）</li>
                                        <li><strong>Mirostat 1.0 / 2.0</strong>: より一貫した品質の出力</li>
                                    </ul>
                                    推奨: 通常は無効でOK。品質が不安定な場合に試す
                                </div>
                            </div>
                        </label>
                        <select id="mirostatSelect" onchange="updateMirostat(this.value)" style="width: 100%; padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0;">
                            <option value="0">無効 (0)</option>
                            <option value="1">Mirostat 1.0</option>
                            <option value="2">Mirostat 2.0</option>
                        </select>
                        <div style="font-size: 0.75rem; color: #999;">動的サンプリングでより一貫した品質</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Mirostat Tau: <span id="mirostatTauValue">デフォルト (5.0)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Mirostat Tau</strong>
                                    範囲: 通常 3.0 〜 10.0<br>
                                    デフォルト: 5.0<br>
                                    Mirostatの目標perplexity（エントロピー）
                                    <ul>
                                        <li><strong>低い値 (3.0〜4.0)</strong>: より予測可能な出力</li>
                                        <li><strong>高い値 (7.0〜10.0)</strong>: より多様な出力</li>
                                    </ul>
                                    ※ Mirostat有効時のみ機能
                                </div>
                            </div>
                        </label>
                        <input type="range" id="mirostatTauSlider" min="0.1" max="10.0" step="0.1" value="5.0"
                               oninput="updateMirostatTau(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">Mirostat有効時の目標エントロピー</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Mirostat Eta: <span id="mirostatEtaValue">デフォルト (0.1)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Mirostat Eta</strong>
                                    範囲: 通常 0.05 〜 0.2<br>
                                    デフォルト: 0.1<br>
                                    Mirostatの学習率（適応速度）
                                    <ul>
                                        <li><strong>低い値 (0.05)</strong>: 緩やかな調整、安定</li>
                                        <li><strong>高い値 (0.2)</strong>: 速い調整、応答的</li>
                                    </ul>
                                    ※ Mirostat有効時のみ機能
                                </div>
                            </div>
                        </label>
                        <input type="range" id="mirostatEtaSlider" min="0.01" max="1.0" step="0.01" value="0.1"
                               oninput="updateMirostatEta(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">Mirostat有効時の学習率</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            TFS-Z: <span id="tfsZValue">デフォルト (1.0)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>TFS-Z (Tail Free Sampling)</strong>
                                    範囲: 0.5 〜 1.0<br>
                                    デフォルト: 1.0（無効）<br>
                                    低確率のトークン（テール部分）を除外
                                    <ul>
                                        <li><strong>1.0</strong>: 無効（除外なし）</li>
                                        <li><strong>0.9〜0.95</strong>: 軽度の除外、品質向上</li>
                                        <li><strong>0.5〜0.8</strong>: 強い除外、一貫性重視</li>
                                    </ul>
                                    推奨: 通常は1.0（無効）。品質向上したい場合は0.95から試す
                                </div>
                            </div>
                        </label>
                        <input type="range" id="tfsZSlider" min="1.0" max="2.0" step="0.05" value="1.0"
                               oninput="updateTfsZ(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">Tail Free Sampling。1.0=無効</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Min-P: <span id="minPValue">デフォルト (0.0)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Min-P (最小確率閾値)</strong>
                                    範囲: 0.0 〜 1.0<br>
                                    デフォルト: 0.0（無効）<br>
                                    Top-Pより新しく効果的なサンプリング手法
                                    <ul>
                                        <li><strong>0.0</strong>: 無効</li>
                                        <li><strong>0.05〜0.1</strong>: 品質向上の推奨値</li>
                                        <li><strong>0.2〜0.5</strong>: より保守的な出力</li>
                                    </ul>
                                    推奨: 0.05から試してみる
                                </div>
                            </div>
                        </label>
                        <input type="range" id="minPSlider" min="0.0" max="1.0" step="0.05" value="0.0"
                               oninput="updateMinP(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">最小確率閾値。0.0=無効</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Presence Penalty: <span id="presencePenaltyValue">デフォルト (0.0)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Presence Penalty (新トピック促進)</strong>
                                    範囲: -2.0 〜 2.0<br>
                                    デフォルト: 0.0<br>
                                    新しい話題への移行を促す
                                    <ul>
                                        <li><strong>0.0</strong>: ペナルティなし</li>
                                        <li><strong>0.5〜1.0</strong>: 適度に多様な話題</li>
                                        <li><strong>1.5〜2.0</strong>: 非常に多様な話題</li>
                                    </ul>
                                    推奨: 0.5〜1.0で試す
                                </div>
                            </div>
                        </label>
                        <input type="range" id="presencePenaltySlider" min="-2.0" max="2.0" step="0.1" value="0.0"
                               oninput="updatePresencePenalty(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">新しい話題への移行を促進</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Frequency Penalty: <span id="frequencyPenaltyValue">デフォルト (0.0)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Frequency Penalty (頻度ペナルティ)</strong>
                                    範囲: -2.0 〜 2.0<br>
                                    デフォルト: 0.0<br>
                                    同じ単語の繰り返しを減らす
                                    <ul>
                                        <li><strong>0.0</strong>: ペナルティなし</li>
                                        <li><strong>0.5〜1.0</strong>: 適度な繰り返し防止</li>
                                        <li><strong>1.5〜2.0</strong>: 強い繰り返し防止</li>
                                    </ul>
                                    推奨: 0.5〜1.0で自然な文章に
                                </div>
                            </div>
                        </label>
                        <input type="range" id="frequencyPenaltySlider" min="-2.0" max="2.0" step="0.1" value="0.0"
                               oninput="updateFrequencyPenalty(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">同じ単語の繰り返しを減らす</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Repeat Last N: <span id="repeatLastNValue">デフォルト (64)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Repeat Last N (ペナルティ範囲)</strong>
                                    範囲: 0 〜 256<br>
                                    デフォルト: 64<br>
                                    Repeat Penaltyを適用する範囲（トークン数）
                                    <ul>
                                        <li><strong>32〜64</strong>: 短期的な繰り返し防止</li>
                                        <li><strong>128〜256</strong>: 長期的な繰り返し防止</li>
                                    </ul>
                                </div>
                            </div>
                        </label>
                        <input type="range" id="repeatLastNSlider" min="0" max="256" step="8" value="64"
                               oninput="updateRepeatLastN(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">ペナルティを適用する範囲（トークン数）</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Typical P: <span id="typicalPValue">デフォルト (1.0)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Typical P (Typical Sampling)</strong>
                                    範囲: 0.0 〜 1.0<br>
                                    デフォルト: 1.0（無効）<br>
                                    「典型的」な確率のトークンを選択
                                    <ul>
                                        <li><strong>1.0</strong>: 無効</li>
                                        <li><strong>0.9〜0.95</strong>: より一貫性のある出力</li>
                                        <li><strong>0.5〜0.8</strong>: 非常に保守的な出力</li>
                                    </ul>
                                </div>
                            </div>
                        </label>
                        <input type="range" id="typicalPSlider" min="0.0" max="1.0" step="0.05" value="1.0"
                               oninput="updateTypicalP(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">Typical Sampling。1.0=無効</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Num Thread: <span id="numThreadValue">デフォルト (自動)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Num Thread (スレッド数)</strong>
                                    範囲: 1 〜 32<br>
                                    デフォルト: 自動（CPU性能に応じて）<br>
                                    CPU使用スレッド数を制御
                                    <ul>
                                        <li>通常は自動でOK</li>
                                        <li>他の作業と並行する場合は減らす</li>
                                    </ul>
                                </div>
                            </div>
                        </label>
                        <input type="range" id="numThreadSlider" min="1" max="32" step="1" value="8"
                               oninput="updateNumThread(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">CPU使用スレッド数（上級者向け）</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px;">
                            Num GPU: <span id="numGpuValue">デフォルト (自動)</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Num GPU (GPU層の数)</strong>
                                    範囲: 0 〜 100<br>
                                    デフォルト: 自動（全てGPUで処理）<br>
                                    GPUに載せるモデルの層数
                                    <ul>
                                        <li><strong>0</strong>: CPUのみで実行</li>
                                        <li><strong>自動</strong>: 全てGPUで処理</li>
                                        <li>VRAM不足時は値を下げる</li>
                                    </ul>
                                </div>
                            </div>
                        </label>
                        <input type="range" id="numGpuSlider" min="0" max="100" step="1" value="50"
                               oninput="updateNumGpu(this.value)" style="width: 100%;">
                        <div style="font-size: 0.75rem; color: #999;">GPUに載せる層数（上級者向け）</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="penalizeNewlineToggle" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: 600; font-size: 0.9rem;">Penalize Newline</span>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-text">
                                    <strong>Penalize Newline (改行ペナルティ)</strong>
                                    改行にペナルティを課すかどうか
                                    <ul>
                                        <li>ONにすると改行が少なくなる</li>
                                        <li>長文を一気に生成したい場合に有効</li>
                                    </ul>
                                </div>
                            </div>
                        </label>
                        <div style="font-size: 0.75rem; color: #999;">改行にペナルティを課す</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-main" class="main-tab-content">
            <div class="settings-grid">
                <div class="card">
                    <h2>📄 ドキュメント管理</h2>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">📄</div>
                        <p>クリックまたはドラッグ＆ドロップ</p>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">対応: PDF, TXT, MD, CSV</p>
                        <input type="file" id="fileInput" accept=".pdf,.txt,.md,.csv" multiple onchange="uploadFiles()">
                    </div>

                    <!-- タグ設定エリア -->
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 8px; font-weight: 600;">
                            🏷️ タグ（オプション）
                        </label>
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <input type="text" id="uploadTagInput" placeholder="例: 商品A, マニュアル"
                                   style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 0.9rem;">
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">
                            複数のタグはカンマ区切りで入力してください
                        </div>
                        <!-- 既存タグからの選択 -->
                        <div id="existingTagsArea" style="display: none; margin-top: 10px;">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">既存のタグから選択:</div>
                            <div id="existingTagsList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>📚 登録済みドキュメント <span id="documentCount" style="font-size: 0.85rem; color: #666; font-weight: normal;">(0件)</span></h2>
                    <ul class="document-list" id="documentList">
                        <li style="text-align: center; color: #999;">ドキュメントなし</li>
                    </ul>
                    <button class="btn btn-danger" onclick="clearDocuments()" style="width: 100%; margin-top: 10px;">
                        全て削除
                    </button>
                </div>

                <div class="card">
                    <h2>🤖 モデル設定</h2>
                    <select id="modelSelectSettings" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 0.95rem; margin-bottom: 10px;">
                        <option value="">デフォルト (llama3.2)</option>
                    </select>
                    <button onclick="loadModels()" style="width: 100%; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                        🔄 モデル再読み込み
                    </button>
                    <div id="modelCount" style="font-size: 0.85rem; color: #666; margin-top: 10px;"></div>
                </div>

                <div class="card">
                    <h2>⚙️ システム状態</h2>
                    <div id="healthStatus">確認中...</div>
                </div>

                <div class="card">
                    <h2>💬 キャラクター設定</h2>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 8px; font-weight: 600;">
                            キャラクタープリセット
                        </label>
                        <select id="characterPreset" onchange="toggleCustomCharacter()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 0.95rem;">
                            <option value="">なし（デフォルト）</option>
                            <option value="samurai">侍</option>
                            <option value="teacher">先生</option>
                            <option value="gyaru">ギャル</option>
                            <option value="kansai">関西弁</option>
                            <option value="scientist">科学者</option>
                            <option value="cat">猫</option>
                            <option value="moe">萌え系</option>
                            <option value="custom">カスタム</option>
                        </select>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 5px;">AIの話し方を変更できます</div>
                    </div>

                    <div id="customCharacterSection" style="display: none;">
                        <label style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 8px; font-weight: 600;">
                            カスタムキャラクター設定
                        </label>
                        <textarea id="customCharacterPrompt"
                                  placeholder="例: あなたは親切なロボットです。丁寧で論理的に説明してください。"
                                  rows="4"
                                  oninput="saveCustomCharacterPrompt()"
                                  style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-family: inherit; resize: vertical; font-size: 0.95rem;"></textarea>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 5px;">AIの振る舞いを自由に指定できます</div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- 参照元プレビューモーダル -->
    <div id="documentPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 20px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #333;" id="previewTitle">ドキュメントプレビュー</h3>
                <button onclick="closeDocumentPreview()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">×</button>
            </div>
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <div id="previewContent" style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; color: #333;"></div>
            </div>
        </div>
    </div>

    <script src="/js/script.js"></script>
</body>
</html>
