<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM RAG System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .container > div:not(.header) {
            padding: 20px 30px;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ: ãƒ˜ãƒƒãƒ€ãƒ¼ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .container > div:not(.header) {
                padding: 15px;
            }
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #333;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
            gap: 5px;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
            background: #f0f0ff;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .document-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .document-item {
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            border: 1px solid #e0e0e0;
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .sources {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.9rem;
            color: #666;
        }

        .sources-title {
            font-weight: 600;
            margin-bottom: 5px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .sources-title:hover {
            color: #667eea;
        }

        .sources-toggle {
            font-size: 0.8rem;
            transition: transform 0.3s;
        }

        .sources-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .sources-list {
            margin-top: 5px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }

        .sources-list.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-area input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .main-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .main-tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            text-align: center;
        }

        .main-tab:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }

        .main-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f0f0ff;
            border-radius: 10px;
            margin: 10px 0;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .upload-loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .container > div:not(.header) {
                padding: 15px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .main-tabs {
                flex-direction: row;
                gap: 5px;
            }

            .main-tab {
                padding: 12px 10px;
                font-size: 0.95rem;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
            .chat-area {
                height: calc(100vh - 380px);
                min-height: 400px;
            }

            .chat-messages {
                padding: 15px;
            }

            .message {
                max-width: 90%;
                padding: 12px;
                font-size: 0.95rem;
            }

            .input-area {
                flex-direction: row;
                gap: 8px;
            }

            .input-area input {
                padding: 12px;
                font-size: 0.95rem;
            }

            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
                white-space: nowrap;
            }

            .btn-primary, .btn-secondary {
                min-width: auto;
            }

            /* ã‚«ãƒ¼ãƒ‰å†…ã®è¦ç´  */
            .card h2, .card h3 {
                font-size: 1.3rem;
            }

            /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
            .upload-area {
                padding: 25px 15px;
            }

            /* ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ */
            .document-list {
                max-height: 200px;
            }

            /* ãƒ¢ãƒ‡ãƒ«é¸æŠ */
            #modelSelect, #modelSelectSettings {
                font-size: 0.85rem;
                padding: 6px !important;
                min-width: 0;
            }

            /* ãƒ¢ãƒ‡ãƒ«é¸æŠã‚¨ãƒªã‚¢å…¨ä½“ */
            .card > div:has(#modelSelect) {
                flex-wrap: wrap;
                gap: 5px !important;
            }

            .card label {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Local LLM RAG System</h1>
            <p>Powered by Ollama, LangChain & FastAPI</p>
        </div>

        <div class="main-tabs">
            <button class="main-tab active" onclick="switchMainTab('chat')">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</button>
            <button class="main-tab" onclick="switchMainTab('settings')">âš™ï¸ è¨­å®š</button>
        </div>

        <div id="chat-main" class="main-tab-content active">
            <div class="card">
                <h2>ãƒãƒ£ãƒƒãƒˆ</h2>
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                    <label style="font-weight: 600; color: #333; white-space: nowrap;">ãƒ¢ãƒ‡ãƒ«:</label>
                    <select id="modelSelect" style="flex: 1; padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 0.95rem;">
                        <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (llama3.2)</option>
                    </select>
                </div>
                <div class="chat-area">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="message-header">ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
                            <div>ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€è³ªå•ã—ã¦ãã ã•ã„ã€‚</div>
                        </div>
                    </div>
                    <div class="input-area">
                        <input
                            type="text"
                            id="questionInput"
                            placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                            onkeypress="handleKeyPress(event)"
                        >
                        <button class="btn btn-primary" onclick="sendQuestion()">é€ä¿¡</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-main" class="main-tab-content">
            <div class="settings-grid">
                <div class="card">
                    <h2>ğŸ“„ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†</h2>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">ğŸ“„</div>
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">å¯¾å¿œ: PDF, TXT, MD, CSV</p>
                        <input type="file" id="fileInput" accept=".pdf,.txt,.md,.csv" multiple onchange="uploadFiles()">
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“š ç™»éŒ²æ¸ˆã¿ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</h2>
                    <ul class="document-list" id="documentList">
                        <li style="text-align: center; color: #999;">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã—</li>
                    </ul>
                    <button class="btn btn-danger" onclick="clearDocuments()" style="width: 100%; margin-top: 10px;">
                        å…¨ã¦å‰Šé™¤
                    </button>
                </div>

                <div class="card">
                    <h2>ğŸ¤– ãƒ¢ãƒ‡ãƒ«è¨­å®š</h2>
                    <select id="modelSelectSettings" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e0e0e0; font-size: 0.95rem; margin-bottom: 10px;">
                        <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (llama3.2)</option>
                    </select>
                    <button onclick="loadModels()" style="width: 100%; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                        ğŸ”„ ãƒ¢ãƒ‡ãƒ«å†èª­ã¿è¾¼ã¿
                    </button>
                    <div id="modelCount" style="font-size: 0.85rem; color: #666; margin-top: 10px;"></div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h2>
                    <div id="healthStatus">ç¢ºèªä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç¾åœ¨ã®ãƒ›ã‚¹ãƒˆåã¨ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ï¼ˆåˆ¥PCã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾å¿œï¼‰
        // é–‹ç™ºæ™‚: http://localhost:8000
        // åˆ¥PCã‹ã‚‰: http://[ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹]:8000
        const API_BASE_URL = window.location.origin;

        // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchMainTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
            const tabs = document.querySelectorAll('.main-tab');
            const tabContents = document.querySelectorAll('.main-tab-content');

            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰ active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã¨å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            event.target.classList.add('active');
            document.getElementById(tabName + '-main').classList.add('active');
        }

        // åˆæœŸåŒ–
        async function init() {
            await checkHealth();
            await loadDocuments();
            await loadModels();
        }

        // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                const statusDiv = document.getElementById('healthStatus');

                if (data.status === 'healthy' && data.ollama_available) {
                    statusDiv.innerHTML = '<div class="status success">æ­£å¸¸ã«å‹•ä½œä¸­</div>';
                } else if (data.status === 'healthy') {
                    statusDiv.innerHTML = '<div class="status error">Ollamaæœªæ¥ç¶š</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">ã‚¨ãƒ©ãƒ¼</div>';
                }
            } catch (error) {
                document.getElementById('healthStatus').innerHTML =
                    '<div class="status error">ã‚µãƒ¼ãƒãƒ¼æœªæ¥ç¶š</div>';
            }
        }

        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿
        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE_URL}/documents`);
                const data = await response.json();
                const listElement = document.getElementById('documentList');

                if (data.documents.length === 0) {
                    listElement.innerHTML = '<li style="text-align: center; color: #999;">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã—</li>';
                } else {
                    listElement.innerHTML = data.documents
                        .map(doc => `<li class="document-item">${doc}</li>`)
                        .join('');
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        // ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿
        async function loadModels() {
            const modelCountDiv = document.getElementById('modelCount');
            try {
                modelCountDiv.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';

                const response = await fetch(`${API_BASE_URL}/models`);
                const data = await response.json();

                // ä¸¡æ–¹ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                const selectElement = document.getElementById('modelSelect');
                const selectElementSettings = document.getElementById('modelSelectSettings');

                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜
                const currentValue = selectElement.value;

                // ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³HTMLã‚’æ§‹ç¯‰
                let optionsHTML = '<option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (llama3.2)</option>';

                // å–å¾—ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 
                if (data.models && data.models.length > 0) {
                    // ãƒ¢ãƒ‡ãƒ«ã‚’åå‰é †ã«ã‚½ãƒ¼ãƒˆ
                    const sortedModels = data.models.sort();

                    sortedModels.forEach(model => {
                        optionsHTML += `<option value="${model}">${model}</option>`;
                    });

                    // ä¸¡æ–¹ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                    selectElement.innerHTML = optionsHTML;
                    selectElementSettings.innerHTML = optionsHTML;

                    // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                    if (currentValue) {
                        selectElement.value = currentValue;
                        selectElementSettings.value = currentValue;
                    }

                    modelCountDiv.innerHTML = `âœ“ ${data.models.length} å€‹ã®ãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨å¯èƒ½`;
                    modelCountDiv.style.color = '#155724';
                } else {
                    selectElement.innerHTML = optionsHTML;
                    selectElementSettings.innerHTML = optionsHTML;

                    modelCountDiv.innerHTML = 'âš  ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    modelCountDiv.style.color = '#856404';
                }
            } catch (error) {
                console.error('Error loading models:', error);
                modelCountDiv.innerHTML = 'âœ— ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                modelCountDiv.style.color = '#721c24';
            }
        }

        // ãƒ¢ãƒ‡ãƒ«é¸æŠã‚’åŒæœŸ
        document.addEventListener('DOMContentLoaded', function() {
            const selectElement = document.getElementById('modelSelect');
            const selectElementSettings = document.getElementById('modelSelectSettings');

            selectElement.addEventListener('change', function() {
                selectElementSettings.value = this.value;
            });

            selectElementSettings.addEventListener('change', function() {
                selectElement.value = this.value;
            });
        });

        // é€šçŸ¥ã‚’è¡¨ç¤º
        function showNotification(message, type = 'info') {
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // æ–°ã—ã„é€šçŸ¥ã‚’ä½œæˆ
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // 3ç§’å¾Œã«è‡ªå‹•çš„ã«å‰Šé™¤
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            if (files.length === 0) return;

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const uploadArea = document.querySelector('.upload-area');
            const originalContent = uploadArea.innerHTML;
            uploadArea.innerHTML = `
                <div class="upload-loading">
                    <div class="loading-spinner" style="margin: 0 auto 10px;"></div>
                    <div>${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
                </div>
            `;
            uploadArea.style.pointerEvents = 'none';

            try {
                showNotification(`${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'info');

                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${data.files.join(', ')}`, 'success');
                    await loadDocuments();
                } else {
                    showNotification(`ã‚¨ãƒ©ãƒ¼: ${data.detail}`, 'error');
                }
            } catch (error) {
                showNotification(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å…ƒã«æˆ»ã™
                uploadArea.innerHTML = originalContent;
                uploadArea.style.pointerEvents = 'auto';
                fileInput.value = '';
            }
        }

        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤
        async function clearDocuments() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/documents`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    await loadDocuments();
                } else {
                    showNotification('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showNotification(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // è³ªå•é€ä¿¡
        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect.value;

            if (!question) return;

            addMessage('ã‚ãªãŸ', question, 'user');
            input.value = '';

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            const loadingId = addLoadingMessage();

            try {
                const requestBody = {
                    question,
                    stream: false
                };

                // ãƒ¢ãƒ‡ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¿½åŠ 
                if (selectedModel) {
                    requestBody.model = selectedModel;
                }

                const response = await fetch(`${API_BASE_URL}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
                removeLoadingMessage(loadingId);

                if (response.ok) {
                    addMessage('ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ', data.answer, 'assistant', data.sources);
                } else {
                    addMessage('ã‚·ã‚¹ãƒ†ãƒ ', `ã‚¨ãƒ©ãƒ¼: ${data.detail}`, 'error');
                }
            } catch (error) {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
                removeLoadingMessage(loadingId);
                addMessage('ã‚·ã‚¹ãƒ†ãƒ ', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        function addLoadingMessage() {
            const messagesDiv = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();

            loadingDiv.id = loadingId;
            loadingDiv.className = 'loading-message';
            loadingDiv.innerHTML = `
                <div class="loading-spinner"></div>
                <div>å›ç­”ã‚’ç”Ÿæˆä¸­...</div>
            `;

            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return loadingId;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        function removeLoadingMessage(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addMessage(sender, text, type = 'assistant', sources = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');

            let className = 'message';
            if (type === 'user') className += ' user';
            else if (type === 'assistant') className += ' assistant';

            messageDiv.className = className;

            let html = `<div class="message-header">${sender}</div><div>${text}</div>`;

            if (sources && sources.length > 0) {
                const sourceId = 'sources-' + Date.now();
                html += `
                    <div class="sources">
                        <div class="sources-title" onclick="toggleSources('${sourceId}')">
                            <span class="sources-toggle" id="${sourceId}-toggle">â–¼</span>
                            å‚ç…§å…ƒ (${sources.length}ä»¶)
                        </div>
                        <div class="sources-list" id="${sourceId}">
                            ${sources.map(s => `<div>â€¢ ${s}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            messageDiv.innerHTML = html;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // å‚ç…§å…ƒã®é–‹é–‰
        function toggleSources(sourceId) {
            const sourcesList = document.getElementById(sourceId);
            const toggle = document.getElementById(sourceId + '-toggle');

            if (sourcesList && toggle) {
                sourcesList.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
            }
        }

        // Enter ã‚­ãƒ¼ã§é€ä¿¡
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendQuestion();
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();

        // å®šæœŸçš„ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        setInterval(checkHealth, 30000);
    </script>
</body>
</html>
