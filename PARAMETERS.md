# パラメータ設定ガイド

LocalLLM RAGシステムの各種パラメータの詳細説明です。

## 📋 目次
- [主要パラメータ](#主要パラメータ)
- [詳細パラメータ](#詳細パラメータ)
- [推奨設定](#推奨設定)

---

## 主要パラメータ

### ⭐ Temperature (創造性)
- **範囲**: 0.0 〜 1.0
- **デフォルト**: 0.3
- **説明**: LLMの出力の創造性・ランダム性を制御
- **効果**:
  - **低い値 (0.0 〜 0.3)**: 一貫性が高く、予測可能な回答
    - 事実に基づく質問、技術文書の要約に最適
  - **中程度 (0.4 〜 0.7)**: バランスの取れた出力
    - 一般的な会話、アイデア出しに適切
  - **高い値 (0.8 〜 1.0)**: 創造的で多様な回答
    - ブレインストーミング、創作活動に有効

**推奨値**:
- RAG用途（文書ベース回答）: 0.2 〜 0.4
- 一般会話: 0.5 〜 0.7
- 創作活動: 0.8 〜 1.0

---

### ⭐ 検索ドキュメント数
- **範囲**: 3 〜 20
- **デフォルト**: 10
- **説明**: 回答生成に使用するドキュメントの数
- **効果**:
  - **少ない (3 〜 5)**:
    - ✅ 高速
    - ✅ コンテキストがシンプル
    - ❌ 情報が不足する可能性
  - **多い (10 〜 20)**:
    - ✅ より正確で詳細な回答
    - ✅ 多角的な視点
    - ❌ 生成速度が低下
    - ❌ トークン数増加

**推奨値**:
- 簡単な質問: 5
- 標準的な質問: 10
- 複雑な質問: 15 〜 20

---

### ⭐ 検索範囲倍率
- **範囲**: 2 〜 20倍
- **デフォルト**: 10倍
- **説明**: 実際に検索する候補数（ドキュメント数 × 倍率）
- **計算例**:
  - ドキュメント数: 10、倍率: 10 → **100件検索**して上位10件を使用
  - ドキュメント数: 5、倍率: 20 → **100件検索**して上位5件を使用
- **効果**:
  - **低い倍率 (2 〜 5)**:
    - ✅ 高速
    - ❌ 関連性の低いドキュメントが混入する可能性
  - **高い倍率 (10 〜 20)**:
    - ✅ より関連性の高いドキュメントを選択
    - ✅ 検索精度向上（特に日本語）
    - ❌ わずかに速度低下

**推奨値**:
- 高速優先: 5
- 標準: 10
- 精度最優先: 15 〜 20

---

### ⭐ Top-P (多様性)
- **範囲**: 0.1 〜 1.0
- **デフォルト**: 0.9
- **説明**: Nucleus sampling。累積確率がこの値に達するまでのトークンから選択
- **効果**:
  - **低い値 (0.1 〜 0.5)**:
    - 確実性の高い単語のみを選択
    - 一貫性重視
  - **高い値 (0.8 〜 1.0)**:
    - より多様な単語候補を考慮
    - 表現の幅が広がる

**推奨値**:
- 事実ベース: 0.7 〜 0.8
- 標準: 0.9
- 創造的: 0.95 〜 1.0

---

### ⭐ Repeat Penalty (繰り返し抑制)
- **範囲**: 1.0 〜 1.5
- **デフォルト**: 1.1
- **説明**: 同じ単語やフレーズの繰り返しを抑制
- **効果**:
  - **1.0**: ペナルティなし（繰り返しを許容）
  - **1.1 〜 1.2**: 適度に抑制（推奨）
  - **1.3以上**: 強い抑制（不自然になる可能性）

**推奨値**:
- リスト生成など繰り返しが必要: 1.0
- 標準: 1.1
- 繰り返しを強く抑制: 1.2 〜 1.3

---

### ⭐ Num Predict (最大生成トークン数)
- **範囲**: -1（無制限）、または 128 〜 2048
- **デフォルト**: -1（無制限）
- **説明**: 生成する最大トークン数
- **効果**:
  - **-1 (無制限)**: モデルが自然に終了するまで生成
  - **128 〜 256**: 短い回答（要約、簡潔な説明）
  - **512 〜 1024**: 中程度の回答（標準的な質問）
  - **1024 〜 2048**: 長い回答（詳細な説明、長文生成）

**推奨値**:
- 簡潔な回答: 256
- 標準: 512 〜 1024
- 詳細な回答: -1（無制限）

---

## 詳細パラメータ

### Top-K
- **範囲**: 1 〜 100
- **デフォルト**: 40
- **説明**: 各ステップで考慮する上位K個のトークン候補
- **効果**:
  - **低い値 (10 〜 20)**: より予測可能な出力
  - **高い値 (60 〜 100)**: より多様な出力

**推奨値**: 通常はTop-Pで制御するため、デフォルトのままでOK

---

### Num Ctx (コンテキストサイズ)
- **範囲**: 512 〜 8192
- **デフォルト**: 2048
- **説明**: モデルが一度に考慮できるトークン数（入力+出力）
- **効果**:
  - **512 〜 1024**: 短い会話に十分
  - **2048**: 標準的な会話と文書
  - **4096 〜 8192**: 長文の文書、長い会話履歴

**注意**: 大きくするほどメモリ使用量とレイテンシが増加

**推奨値**:
- 短い質問のみ: 2048
- 長文文書を扱う: 4096
- 非常に長い文書: 8192

---

### Seed (乱数シード)
- **範囲**: 任意の整数、または空欄（ランダム）
- **デフォルト**: ランダム
- **説明**: 同じシードで同じ結果を再現可能にする
- **用途**:
  - デバッグ
  - A/Bテスト
  - 結果の再現性確保

**推奨値**: 通常は空欄（ランダム）でOK

---

### Mirostat
- **選択肢**: 無効(0)、Mirostat 1.0、Mirostat 2.0
- **デフォルト**: 無効(0)
- **説明**: 動的サンプリングアルゴリズム。perplexityを制御して一貫した品質を維持
- **効果**:
  - **無効(0)**: 標準的なサンプリング（Temperature、Top-Pを使用）
  - **Mirostat 1.0 / 2.0**: より一貫した品質の出力

**推奨値**: 通常は無効でOK。品質が不安定な場合に試す

---

### Mirostat Tau
- **範囲**: 通常 3.0 〜 10.0
- **デフォルト**: 5.0
- **説明**: Mirostatの目標perplexity
- **効果**: 高いほど多様な出力

---

### Mirostat Eta
- **範囲**: 通常 0.05 〜 0.2
- **デフォルト**: 0.1
- **説明**: Mirostatの学習率

---

### TFS-Z (Tail Free Sampling)
- **範囲**: 0.5 〜 1.0
- **デフォルト**: 1.0（無効）
- **説明**: 低確率のトークンを除外
- **効果**: 1.0未満で有効化。小さいほど品質向上するが多様性は減少

---

## 推奨設定

### 📝 シナリオ別推奨設定

#### 1. 事実ベースのQ&A（技術文書、マニュアル）
```
Temperature: 0.2
Document Count: 10
Search Multiplier: 10
Top-P: 0.8
Repeat Penalty: 1.1
Num Predict: -1
```

#### 2. 一般的な会話・相談
```
Temperature: 0.6
Document Count: 5
Search Multiplier: 8
Top-P: 0.9
Repeat Penalty: 1.1
Num Predict: -1
```

#### 3. 創作・アイデア出し
```
Temperature: 0.8
Document Count: 8
Search Multiplier: 10
Top-P: 0.95
Repeat Penalty: 1.0
Num Predict: -1
```

#### 4. 要約・簡潔な回答
```
Temperature: 0.3
Document Count: 10
Search Multiplier: 10
Top-P: 0.85
Repeat Penalty: 1.2
Num Predict: 256
```

#### 5. 精度最優先（重要な判断）
```
Temperature: 0.1
Document Count: 15
Search Multiplier: 15
Top-P: 0.7
Repeat Penalty: 1.1
Num Predict: -1
```

---

## ⚡ パフォーマンスチューニング

### 速度重視
- Document Count: 3 〜 5
- Search Multiplier: 5
- Num Ctx: 2048
- Num Predict: 512

### 精度重視
- Document Count: 15 〜 20
- Search Multiplier: 15 〜 20
- Num Ctx: 4096
- Num Predict: -1

### バランス型（推奨）
- Document Count: 10
- Search Multiplier: 10
- Num Ctx: 2048
- Num Predict: -1

---

## 🔧 トラブルシューティング

### 問題: 回答が不正確
**対策**:
1. Document Count を増やす（10 → 15）
2. Search Multiplier を増やす（10 → 15）
3. Temperature を下げる（0.3 → 0.2）

### 問題: 回答が短すぎる
**対策**:
1. Num Predict を増やすか -1（無制限）に
2. Temperature を少し上げる

### 問題: 同じフレーズを繰り返す
**対策**:
1. Repeat Penalty を上げる（1.1 → 1.2）
2. Temperature を調整

### 問題: 回答が遅い
**対策**:
1. Document Count を減らす（10 → 5）
2. Search Multiplier を減らす（10 → 5）
3. Num Ctx を小さく（4096 → 2048）

### 問題: 関連性の低い文書が参照される
**対策**:
1. Search Multiplier を大きく（10 → 20）
2. クエリ拡張をONにする
3. 文書の再アップロード（埋め込みベクトル再生成）

---

## 📊 パラメータ間の相互作用

### Temperature × Top-P
- 両方低い → 非常に保守的な出力
- Temperature高 + Top-P低 → 選ばれた範囲内で多様
- Temperature低 + Top-P高 → あまり意味がない
- 両方高い → 最も創造的だが不安定

### Document Count × Search Multiplier
- 検索精度 = Document Count × Search Multiplier
- 例: 10 × 10 = 100件から上位10件選択
- 倍率が高いほど「より良い10件」を選べる

### Temperature × Repeat Penalty
- Temperature高 + Repeat Penalty高 → 多様だが繰り返しなし
- Temperature低 + Repeat Penalty低 → 一貫性重視で繰り返しOK

---

## 💡 Tips

1. **まずデフォルトから始める**: 多くの場合、デフォルト設定で十分
2. **一つずつ調整**: 複数パラメータを同時に変えると原因特定が困難
3. **ログを確認**: デバッグ出力で検索結果のスコアを確認
4. **プリセット活用**: よく使う設定をカスタムプリセットとして保存
5. **RAG vs 直接**: 一般知識の質問ならRAG OFFも検討

---

最終更新: 2025年12月
